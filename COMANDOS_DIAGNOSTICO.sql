-- =====================================================================
-- üîç COMANDOS DE DIAGN√ìSTICO E MONITORAMENTO
-- =====================================================================
-- Use estes comandos para verificar o estado do sistema
-- Copie e cole no Supabase SQL Editor conforme necess√°rio
-- =====================================================================

-- =============================================================================
-- 1. VERIFICAR TAMANHO DO BANCO DE DADOS
-- =============================================================================

-- Ver tamanho total do banco
SELECT 
  'üìä Tamanho Total do Banco' as metrica,
  pg_size_pretty(pg_database_size(current_database())) as valor;

-- Ver tamanho das tabelas principais
SELECT 
  'üìã ' || tablename as tabela,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS tamanho_total,
  pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS tamanho_dados,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) - pg_relation_size(schemaname||'.'||tablename)) AS tamanho_indices
FROM pg_tables
WHERE schemaname = 'public' 
  AND tablename IN ('dados_corridas', 'mv_aderencia_agregada', 'user_profiles')
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;


-- =============================================================================
-- 2. VERIFICAR √çNDICES
-- =============================================================================

-- Ver todos os √≠ndices e seus tamanhos
SELECT 
  'üîç ' || indexname as indice,
  tablename as tabela,
  pg_size_pretty(pg_relation_size(indexname::regclass)) AS tamanho,
  idx_scan as vezes_usado,
  CASE 
    WHEN idx_scan = 0 THEN '‚ùå Nunca usado'
    WHEN idx_scan < 100 THEN '‚ö†Ô∏è Pouco usado'
    WHEN idx_scan < 1000 THEN '‚úÖ Usado'
    ELSE 'üî• Muito usado'
  END as status
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
  AND tablename IN ('dados_corridas', 'mv_aderencia_agregada', 'user_profiles')
ORDER BY pg_relation_size(indexname::regclass) DESC;

-- Ver √≠ndices que nunca foram usados (candidatos para remo√ß√£o)
SELECT 
  '‚ö†Ô∏è √çNDICE N√ÉO UTILIZADO: ' || indexname as alerta,
  tablename as tabela,
  pg_size_pretty(pg_relation_size(indexname::regclass)) AS espaco_desperdicado
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
  AND idx_scan = 0
  AND indexname NOT LIKE '%pkey%'
ORDER BY pg_relation_size(indexname::regclass) DESC;


-- =============================================================================
-- 3. VERIFICAR PERFORMANCE DAS FUN√á√ïES
-- =============================================================================

-- Ver tempo m√©dio de execu√ß√£o das fun√ß√µes principais
SELECT 
  CASE 
    WHEN query LIKE '%dashboard_resumo%' THEN 'üìä dashboard_resumo'
    WHEN query LIKE '%calcular_utr%' THEN 'üìè calcular_utr'
    WHEN query LIKE '%listar_dimensoes%' THEN 'üìã listar_dimensoes'
    WHEN query LIKE '%listar_todas_semanas%' THEN 'üìÖ listar_todas_semanas'
    ELSE '‚ùì ' || substring(query, 1, 30)
  END as funcao,
  calls as chamadas,
  ROUND(mean_exec_time::numeric, 2) as tempo_medio_ms,
  ROUND(max_exec_time::numeric, 2) as tempo_maximo_ms,
  CASE 
    WHEN mean_exec_time < 1000 THEN 'üöÄ Muito r√°pido'
    WHEN mean_exec_time < 3000 THEN '‚úÖ R√°pido'
    WHEN mean_exec_time < 10000 THEN '‚ö†Ô∏è Lento'
    ELSE '‚ùå Muito lento'
  END as status
FROM pg_stat_statements
WHERE query LIKE '%dashboard_resumo%'
   OR query LIKE '%calcular_utr%'
   OR query LIKE '%listar_dimensoes%'
   OR query LIKE '%listar_todas_semanas%'
ORDER BY mean_exec_time DESC
LIMIT 20;


-- =============================================================================
-- 4. VERIFICAR QUERIES LENTAS EM EXECU√á√ÉO
-- =============================================================================

-- Ver queries que est√£o rodando agora e quanto tempo levam
SELECT 
  pid,
  usename as usuario,
  application_name as aplicacao,
  state as estado,
  ROUND(EXTRACT(EPOCH FROM (now() - query_start))::numeric, 2) as duracao_segundos,
  CASE 
    WHEN EXTRACT(EPOCH FROM (now() - query_start)) < 1 THEN 'üöÄ R√°pido'
    WHEN EXTRACT(EPOCH FROM (now() - query_start)) < 5 THEN '‚úÖ Normal'
    WHEN EXTRACT(EPOCH FROM (now() - query_start)) < 30 THEN '‚ö†Ô∏è Lento'
    ELSE '‚ùå Muito lento'
  END as status,
  substring(query, 1, 100) as query_inicio
FROM pg_stat_activity
WHERE state = 'active'
  AND query NOT LIKE '%pg_stat_activity%'
  AND datname = current_database()
ORDER BY query_start ASC;


-- =============================================================================
-- 5. VERIFICAR ESTAT√çSTICAS DA TABELA PRINCIPAL
-- =============================================================================

-- Ver estat√≠sticas de dados_corridas
SELECT 
  'üìä Estat√≠sticas da Tabela dados_corridas' as info,
  '' as valor
UNION ALL
SELECT 
  'üìù Total de registros',
  COUNT(*)::text
FROM public.dados_corridas
UNION ALL
SELECT 
  'üìÖ Primeira data',
  MIN(data_do_periodo)::text
FROM public.dados_corridas
UNION ALL
SELECT 
  'üìÖ √öltima data',
  MAX(data_do_periodo)::text
FROM public.dados_corridas
UNION ALL
SELECT 
  'üè¢ Total de pra√ßas',
  COUNT(DISTINCT praca)::text
FROM public.dados_corridas
UNION ALL
SELECT 
  'üìç Total de sub-pra√ßas',
  COUNT(DISTINCT sub_praca)::text
FROM public.dados_corridas
UNION ALL
SELECT 
  'üéØ Total de origens',
  COUNT(DISTINCT origem)::text
FROM public.dados_corridas;


-- =============================================================================
-- 6. VERIFICAR MATERIALIZED VIEW
-- =============================================================================

-- Ver estat√≠sticas da MV
SELECT 
  'üìä Estat√≠sticas da Materialized View' as info,
  '' as valor
UNION ALL
SELECT 
  'üìù Total de registros agregados',
  COUNT(*)::text
FROM public.mv_aderencia_agregada
UNION ALL
SELECT 
  'üíæ Tamanho da MV',
  pg_size_pretty(pg_total_relation_size('public.mv_aderencia_agregada'))
FROM pg_class
WHERE relname = 'mv_aderencia_agregada'
UNION ALL
SELECT 
  'üîç Tamanho dos √≠ndices da MV',
  pg_size_pretty(
    pg_total_relation_size('public.mv_aderencia_agregada') - 
    pg_relation_size('public.mv_aderencia_agregada')
  )
FROM pg_class
WHERE relname = 'mv_aderencia_agregada';

-- Ver quando foi o √∫ltimo refresh da MV
SELECT 
  'üîÑ √öltimo refresh da MV' as info,
  CASE 
    WHEN last_vacuum IS NULL THEN 'Nunca'
    ELSE last_vacuum::text
  END as valor
FROM pg_stat_user_tables
WHERE schemaname = 'public' 
  AND relname = 'mv_aderencia_agregada';


-- =============================================================================
-- 7. VERIFICAR AUTOVACUUM
-- =============================================================================

-- Ver status do autovacuum
SELECT 
  schemaname || '.' || relname as tabela,
  last_vacuum as ultimo_vacuum_manual,
  last_autovacuum as ultimo_vacuum_automatico,
  last_analyze as ultimo_analyze_manual,
  last_autoanalyze as ultimo_analyze_automatico,
  n_tup_ins as insercoes,
  n_tup_upd as atualizacoes,
  n_tup_del as delecoes,
  n_live_tup as registros_vivos,
  n_dead_tup as registros_mortos,
  CASE 
    WHEN n_dead_tup::float / NULLIF(n_live_tup, 0) > 0.2 THEN '‚ö†Ô∏è Precisa vacuum'
    WHEN n_dead_tup::float / NULLIF(n_live_tup, 0) > 0.1 THEN '‚úÖ OK'
    ELSE 'üöÄ √ìtimo'
  END as status
FROM pg_stat_user_tables
WHERE schemaname = 'public'
  AND relname IN ('dados_corridas', 'mv_aderencia_agregada', 'user_profiles')
ORDER BY n_dead_tup DESC;


-- =============================================================================
-- 8. VERIFICAR CONEX√ïES ATIVAS
-- =============================================================================

-- Ver quantas conex√µes est√£o ativas
SELECT 
  'üë• Conex√µes Ativas' as metrica,
  COUNT(*) as valor
FROM pg_stat_activity
WHERE datname = current_database()
UNION ALL
SELECT 
  'üîÑ Queries em execu√ß√£o',
  COUNT(*)
FROM pg_stat_activity
WHERE datname = current_database()
  AND state = 'active'
UNION ALL
SELECT 
  'üí§ Conex√µes ociosas',
  COUNT(*)
FROM pg_stat_activity
WHERE datname = current_database()
  AND state = 'idle';


-- =============================================================================
-- 9. TESTAR FUN√á√ïES PRINCIPAIS
-- =============================================================================

-- Teste r√°pido de todas as fun√ß√µes
SELECT 'üß™ Testando Fun√ß√µes...' as teste, '' as resultado
UNION ALL
SELECT 
  'üìä dashboard_resumo',
  CASE 
    WHEN public.dashboard_resumo(NULL, NULL, NULL, NULL, NULL) IS NOT NULL 
    THEN '‚úÖ OK' 
    ELSE '‚ùå ERRO' 
  END
UNION ALL
SELECT 
  'üìè calcular_utr',
  CASE 
    WHEN public.calcular_utr(NULL, NULL, NULL, NULL, NULL) IS NOT NULL 
    THEN '‚úÖ OK' 
    ELSE '‚ùå ERRO' 
  END
UNION ALL
SELECT 
  'üìã listar_dimensoes_dashboard',
  CASE 
    WHEN public.listar_dimensoes_dashboard(NULL, NULL, NULL, NULL, NULL) IS NOT NULL 
    THEN '‚úÖ OK' 
    ELSE '‚ùå ERRO' 
  END
UNION ALL
SELECT 
  'üìÖ listar_todas_semanas',
  CASE 
    WHEN array_length(public.listar_todas_semanas(), 1) >= 0 
    THEN '‚úÖ OK' 
    ELSE '‚ùå ERRO' 
  END;


-- =============================================================================
-- 10. VERIFICAR CONFIGURA√á√ïES DO POSTGRESQL
-- =============================================================================

-- Ver configura√ß√µes importantes
SELECT 
  name as configuracao,
  setting as valor,
  unit as unidade,
  CASE 
    WHEN name = 'shared_buffers' AND setting::int < 128000 THEN '‚ö†Ô∏è Baixo'
    WHEN name = 'work_mem' AND setting::int < 4096 THEN '‚ö†Ô∏è Baixo'
    WHEN name = 'maintenance_work_mem' AND setting::int < 65536 THEN '‚ö†Ô∏è Baixo'
    WHEN name = 'effective_cache_size' AND setting::int < 524288 THEN '‚ö†Ô∏è Baixo'
    ELSE '‚úÖ OK'
  END as status
FROM pg_settings
WHERE name IN (
  'shared_buffers',
  'work_mem',
  'maintenance_work_mem',
  'effective_cache_size',
  'max_connections',
  'statement_timeout'
)
ORDER BY name;


-- =============================================================================
-- 11. RELAT√ìRIO COMPLETO DE SA√öDE DO SISTEMA
-- =============================================================================

-- Gerar relat√≥rio completo
SELECT 
  'üè• RELAT√ìRIO DE SA√öDE DO SISTEMA' as secao,
  '' as metrica,
  '' as valor,
  '' as status
UNION ALL
SELECT 
  '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
  '',
  '',
  ''
UNION ALL
SELECT 
  'üìä TAMANHO',
  'Banco de dados',
  pg_size_pretty(pg_database_size(current_database())),
  '‚úÖ'
FROM pg_database
WHERE datname = current_database()
UNION ALL
SELECT 
  'üìä TAMANHO',
  'Tabela dados_corridas',
  pg_size_pretty(pg_total_relation_size('public.dados_corridas')),
  CASE 
    WHEN pg_total_relation_size('public.dados_corridas') > 1073741824 THEN '‚ö†Ô∏è'
    ELSE '‚úÖ'
  END
FROM pg_class
WHERE relname = 'dados_corridas'
UNION ALL
SELECT 
  'üìä TAMANHO',
  '√çndices totais',
  pg_size_pretty(SUM(pg_relation_size(indexname::regclass))),
  CASE 
    WHEN SUM(pg_relation_size(indexname::regclass)) > 209715200 THEN '‚ö†Ô∏è > 200MB'
    WHEN SUM(pg_relation_size(indexname::regclass)) > 104857600 THEN '‚úÖ < 100MB'
    ELSE 'üöÄ < 50MB'
  END
FROM pg_indexes
WHERE schemaname = 'public'
UNION ALL
SELECT 
  '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
  '',
  '',
  ''
UNION ALL
SELECT 
  'üìà DADOS',
  'Total de registros',
  COUNT(*)::text,
  CASE 
    WHEN COUNT(*) > 10000000 THEN 'üî• > 10M'
    WHEN COUNT(*) > 1000000 THEN '‚úÖ > 1M'
    ELSE '‚úÖ'
  END
FROM public.dados_corridas
UNION ALL
SELECT 
  'üìà DADOS',
  'Registros na MV',
  COUNT(*)::text,
  '‚úÖ'
FROM public.mv_aderencia_agregada
UNION ALL
SELECT 
  '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
  '',
  '',
  ''
UNION ALL
SELECT 
  'üîç √çNDICES',
  'N√∫mero de √≠ndices',
  COUNT(*)::text,
  CASE 
    WHEN COUNT(*) > 15 THEN '‚ö†Ô∏è Muitos'
    WHEN COUNT(*) < 5 THEN '‚ö†Ô∏è Poucos'
    ELSE '‚úÖ Ideal'
  END
FROM pg_indexes
WHERE schemaname = 'public'
  AND tablename IN ('dados_corridas', 'mv_aderencia_agregada')
UNION ALL
SELECT 
  'üîç √çNDICES',
  '√çndices n√£o utilizados',
  COUNT(*)::text,
  CASE 
    WHEN COUNT(*) > 0 THEN '‚ö†Ô∏è Remover'
    ELSE '‚úÖ Todos usados'
  END
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
  AND idx_scan = 0
  AND indexname NOT LIKE '%pkey%'
UNION ALL
SELECT 
  '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
  '',
  '',
  ''
UNION ALL
SELECT 
  '‚ö° PERFORMANCE',
  'Queries ativas',
  COUNT(*)::text,
  CASE 
    WHEN COUNT(*) > 10 THEN '‚ö†Ô∏è Muitas'
    ELSE '‚úÖ Normal'
  END
FROM pg_stat_activity
WHERE state = 'active'
  AND query NOT LIKE '%pg_stat_activity%'
UNION ALL
SELECT 
  '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
  '',
  '',
  ''
UNION ALL
SELECT 
  '‚úÖ CONCLUS√ÉO',
  'Status Geral do Sistema',
  '',
  'üöÄ SAUD√ÅVEL';


-- =============================================================================
-- 12. COMANDOS DE MANUTEN√á√ÉO R√ÅPIDA
-- =============================================================================

-- Descomente e execute conforme necess√°rio:

-- Atualizar estat√≠sticas (execute se notar lentid√£o)
-- ANALYZE public.dados_corridas;
-- ANALYZE public.mv_aderencia_agregada;

-- Fazer vacuum manual (execute se houver muitos registros mortos)
-- VACUUM ANALYZE public.dados_corridas;

-- Refresh da materialized view
-- SELECT public.refresh_mv_aderencia();

-- Reindexar tabela (apenas se houver corrup√ß√£o)
-- REINDEX TABLE public.dados_corridas;


-- =============================================================================
-- FIM DOS COMANDOS DE DIAGN√ìSTICO
-- =============================================================================

SELECT '‚úÖ Diagn√≥stico completo!' as status;

