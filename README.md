# Dashboard de Corridas - Sistema de Aderência

Uma aplicação Next.js para visualização de dados de corridas de entregadores, com foco em métricas de aderência semanal.

## 🚀 Funcionalidades

### 📊 Dashboard Principal
- **Totais de Corridas**: Ofertadas, Aceitas, Rejeitadas e Completadas
- **Métricas de Aderência**: Cálculo automático baseado no método do Excel
  - Horas a entregar (escala mínima × duração do período)
  - Horas entregues (tempo disponível absoluto)
  - Percentual de aderência com indicadores visuais

### 📁 Upload de Planilhas
- Upload de arquivos Excel (.xlsx, .xls)
- Processamento automático de grandes volumes de dados
- Validação e conversão de formatos de data/hora
- Batching otimizado para performance

## 🛠️ Instalação e Configuração

### Pré-requisitos
- Node.js 18+
- npm ou yarn
- Conta no [Supabase](https://supabase.com)

### 1. Clone o repositório
```bash
git clone https://github.com/Lypezin/DASHBOARD-GERAL.git
cd DASHBOARD-GERAL
```

### 2. Instale as dependências
```bash
npm install
```

### 3. Configure as variáveis de ambiente
Crie um arquivo `.env.local` na raiz do projeto:
```env
NEXT_PUBLIC_SUPABASE_URL=sua_url_do_supabase
NEXT_PUBLIC_SUPABASE_ANON_KEY=sua_chave_anonima
```

### 4. Configure o banco de dados Supabase

Execute os seguintes comandos no **SQL Editor** do Supabase:

#### 4.1. Tabela de dados
```sql
CREATE TABLE public.dados_corridas (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    data_do_periodo DATE,
    periodo TEXT,
    duracao_do_periodo TEXT,
    numero_minimo_de_entregadores_regulares_na_escala INTEGER,
    tag TEXT,
    id_da_pessoa_entregadora TEXT,
    pessoa_entregadora TEXT,
    praca TEXT,
    sub_praca TEXT,
    origem TEXT,
    tempo_disponivel_escalado TEXT,
    tempo_disponivel_absoluto TEXT,
    numero_de_corridas_ofertadas INTEGER,
    numero_de_corridas_aceitas INTEGER,
    numero_de_corridas_rejeitadas INTEGER,
    numero_de_corridas_completadas INTEGER,
    numero_de_corridas_canceladas_pela_pessoa_entregadora INTEGER,
    numero_de_pedidos_aceitos_e_concluidos INTEGER,
    soma_das_taxas_das_corridas_aceitas NUMERIC(10,2),
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### 4.2. Permissões
```sql
ALTER TABLE public.dados_corridas ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Enable read access for all users"
ON public.dados_corridas
FOR SELECT
USING (true);

CREATE POLICY "Enable insert for anon users"
ON public.dados_corridas
FOR INSERT
WITH CHECK (true);
```

#### 4.3. Funções RPC (para evitar limite de 1000 linhas)
```sql
-- Totais de corridas
DROP FUNCTION IF EXISTS public.dashboard_totals();

CREATE OR REPLACE FUNCTION public.dashboard_totals()
RETURNS TABLE (
  corridas_ofertadas numeric,
  corridas_aceitas numeric,
  corridas_rejeitadas numeric,
  corridas_completadas numeric
)
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT
    COALESCE(SUM(numero_de_corridas_ofertadas), 0) AS corridas_ofertadas,
    COALESCE(SUM(numero_de_corridas_aceitas), 0) AS corridas_aceitas,
    COALESCE(SUM(numero_de_corridas_rejeitadas), 0) AS corridas_rejeitadas,
    COALESCE(SUM(numero_de_corridas_completadas), 0) AS corridas_completadas
  FROM public.dados_corridas;
$$;

-- Cálculo de Aderência Semanal
CREATE OR REPLACE FUNCTION public.calcular_aderencia_semanal()
RETURNS TABLE (
  semana text,
  horas_a_entregar text,
  horas_entregues text,
  aderencia_percentual numeric
)
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
WITH dados_unicos AS (
  SELECT DISTINCT
    data_do_periodo,
    periodo,
    numero_minimo_de_entregadores_regulares_na_escala,
    duracao_do_periodo
  FROM public.dados_corridas
  WHERE data_do_periodo IS NOT NULL
    AND periodo IS NOT NULL
    AND numero_minimo_de_entregadores_regulares_na_escala IS NOT NULL
    AND duracao_do_periodo IS NOT NULL
    AND duracao_do_periodo != '00:00:00'
),
horas_por_semana AS (
  SELECT
    'Semana ' || TO_CHAR(data_do_periodo, 'WW') AS semana,
    SUM(
      numero_minimo_de_entregadores_regulares_na_escala *
      (EXTRACT(EPOCH FROM (duracao_do_periodo::interval)) / 3600.0)
    ) AS horas_a_entregar_segundos,
    COALESCE(
      SUM(EXTRACT(EPOCH FROM (tempo_disponivel_absoluto::interval))),
      0
    ) AS horas_entregues_segundos
  FROM dados_unicos du
  LEFT JOIN public.dados_corridas dc ON
    du.data_do_periodo = dc.data_do_periodo AND
    du.periodo = dc.periodo AND
    du.numero_minimo_de_entregadores_regulares_na_escala = dc.numero_minimo_de_entregadores_regulares_na_escala
  GROUP BY TO_CHAR(data_do_periodo, 'WW')
  ORDER BY semana DESC
)
SELECT
  semana,
  TO_CHAR(
    INTERVAL '1 second' * FLOOR(horas_a_entregar_segundos),
    'HH24:MI:SS'
  ) AS horas_a_entregar,
  TO_CHAR(
    INTERVAL '1 second' * FLOOR(horas_entregues_segundos),
    'HH24:MI:SS'
  ) AS horas_entregues,
  CASE
    WHEN horas_a_entregar_segundos > 0 THEN
      ROUND((horas_entregues_segundos / horas_a_entregar_segundos) * 100, 2)
    ELSE 0
  END AS aderencia_percentual
FROM horas_por_semana;
$$;

GRANT EXECUTE ON FUNCTION public.dashboard_totals() TO anon, authenticated, service_role;
GRANT EXECUTE ON FUNCTION public.calcular_aderencia_semanal() TO anon, authenticated, service_role;
```

### 5. Execute o projeto
```bash
npm run dev
```

Acesse http://localhost:3000

## 📋 Como Usar

### Upload de Dados
1. Vá para a página "Upload"
2. Selecione um arquivo Excel (.xlsx ou .xls)
3. Clique em "Enviar Dados"
4. Aguarde o processamento (pode levar alguns minutos para arquivos grandes)

### Dashboard
- **Página inicial**: Mostra totais de corridas e métricas de aderência
- **Indicadores visuais**: Gráfico circular para percentual de aderência
- **Histórico**: Tabela com dados das últimas 10 semanas

## 🔧 Estrutura do Projeto

```
├── src/
│   ├── app/
│   │   ├── page.tsx           # Dashboard principal
│   │   ├── upload/
│   │   │   └── page.tsx       # Página de upload
│   │   └── layout.tsx         # Layout raiz
│   └── lib/
│       └── supabaseClient.ts  # Cliente Supabase
├── dashboard_rpc.sql          # Funções SQL para o banco
└── README.md
```

## 🎯 Cálculo de Aderência

O sistema replica exatamente o método usado no Excel:

1. **Remove duplicatas** baseado em data, período e escala mínima
2. **Calcula horas a entregar**: `escala_mínima × duração_período`
3. **Soma horas entregues**: `tempo_disponível_absoluto` de todos os registros relacionados
4. **Calcula percentual**: `(horas_entregues / horas_a_entregar) × 100`

### Exemplo prático:
- Semana 35: 14.893:54:00 (a entregar) vs 5.048:50:56 (entregues) = 33,9%

## 🚨 Limites e Considerações

- **Supabase PostgREST**: Limitado a 1000 linhas por consulta
- **RPC Functions**: Usadas para aggregações sem limite
- **Upload**: Processa arquivos grandes com batching (500 registros/lote)
- **Performance**: Otimizado para datasets de até 100k+ linhas

## 🔒 Segurança

- RLS habilitado na tabela
- Políticas de leitura/escrita configuradas
- Dados sensíveis protegidos via variáveis de ambiente

## 📈 Próximas Funcionalidades

- Filtros por data/período/praça
- Export de relatórios
- Gráficos avançados
- Notificações de upload
- Backup automático

---

Desenvolvido para análise de performance de entregadores com foco em métricas de aderência operacional.
