# Dashboard de Corridas - Sistema de AderÃªncia

Uma aplicaÃ§Ã£o Next.js para visualizaÃ§Ã£o de dados de corridas de entregadores, com foco em mÃ©tricas de aderÃªncia semanal.

## ğŸš€ Funcionalidades

### ğŸ“Š Dashboard Principal
- **Totais de Corridas**: Ofertadas, Aceitas, Rejeitadas e Completadas
- **MÃ©tricas de AderÃªncia**: CÃ¡lculo automÃ¡tico baseado no mÃ©todo do Excel
  - Horas a entregar (escala mÃ­nima Ã— duraÃ§Ã£o do perÃ­odo)
  - Horas entregues (tempo disponÃ­vel absoluto)
  - Percentual de aderÃªncia com indicadores visuais

### ğŸ“ Upload de Planilhas
- Upload de arquivos Excel (.xlsx, .xls)
- Processamento automÃ¡tico de grandes volumes de dados
- ValidaÃ§Ã£o e conversÃ£o de formatos de data/hora
- Batching otimizado para performance

## ğŸ› ï¸ InstalaÃ§Ã£o e ConfiguraÃ§Ã£o

### PrÃ©-requisitos
- Node.js 18+
- npm ou yarn
- Conta no [Supabase](https://supabase.com)

### 1. Clone o repositÃ³rio
```bash
git clone https://github.com/Lypezin/DASHBOARD-GERAL.git
cd DASHBOARD-GERAL
```

### 2. Instale as dependÃªncias
```bash
npm install
```

### 3. Configure as variÃ¡veis de ambiente
Crie um arquivo `.env.local` na raiz do projeto:
```env
NEXT_PUBLIC_SUPABASE_URL=sua_url_do_supabase
NEXT_PUBLIC_SUPABASE_ANON_KEY=sua_chave_anonima
```

### 4. Configure o banco de dados Supabase

Execute os seguintes comandos no **SQL Editor** do Supabase:

#### 4.1. Tabela de dados
```sql
CREATE TABLE public.dados_corridas (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    data_do_periodo DATE,
    periodo TEXT,
    duracao_do_periodo TEXT,
    numero_minimo_de_entregadores_regulares_na_escala INTEGER,
    tag TEXT,
    id_da_pessoa_entregadora TEXT,
    pessoa_entregadora TEXT,
    praca TEXT,
    sub_praca TEXT,
    origem TEXT,
    tempo_disponivel_escalado TEXT,
    tempo_disponivel_absoluto TEXT,
    numero_de_corridas_ofertadas INTEGER,
    numero_de_corridas_aceitas INTEGER,
    numero_de_corridas_rejeitadas INTEGER,
    numero_de_corridas_completadas INTEGER,
    numero_de_corridas_canceladas_pela_pessoa_entregadora INTEGER,
    numero_de_pedidos_aceitos_e_concluidos INTEGER,
    soma_das_taxas_das_corridas_aceitas NUMERIC(10,2),
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### 4.2. PermissÃµes
```sql
ALTER TABLE public.dados_corridas ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Enable read access for all users"
ON public.dados_corridas
FOR SELECT
USING (true);

CREATE POLICY "Enable insert for anon users"
ON public.dados_corridas
FOR INSERT
WITH CHECK (true);
```

#### 4.3. FunÃ§Ãµes RPC (para evitar limite de 1000 linhas)
```sql
-- Totais de corridas
DROP FUNCTION IF EXISTS public.dashboard_totals();

CREATE OR REPLACE FUNCTION public.dashboard_totals()
RETURNS TABLE (
  corridas_ofertadas numeric,
  corridas_aceitas numeric,
  corridas_rejeitadas numeric,
  corridas_completadas numeric
)
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT
    COALESCE(SUM(numero_de_corridas_ofertadas), 0) AS corridas_ofertadas,
    COALESCE(SUM(numero_de_corridas_aceitas), 0) AS corridas_aceitas,
    COALESCE(SUM(numero_de_corridas_rejeitadas), 0) AS corridas_rejeitadas,
    COALESCE(SUM(numero_de_corridas_completadas), 0) AS corridas_completadas
  FROM public.dados_corridas;
$$;

-- CÃ¡lculo de AderÃªncia Semanal
CREATE OR REPLACE FUNCTION public.calcular_aderencia_semanal()
RETURNS TABLE (
  semana text,
  horas_a_entregar text,
  horas_entregues text,
  aderencia_percentual numeric
)
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
WITH dados_unicos AS (
  SELECT DISTINCT
    data_do_periodo,
    periodo,
    numero_minimo_de_entregadores_regulares_na_escala,
    duracao_do_periodo
  FROM public.dados_corridas
  WHERE data_do_periodo IS NOT NULL
    AND periodo IS NOT NULL
    AND numero_minimo_de_entregadores_regulares_na_escala IS NOT NULL
    AND duracao_do_periodo IS NOT NULL
    AND duracao_do_periodo != '00:00:00'
),
horas_por_semana AS (
  SELECT
    'Semana ' || TO_CHAR(data_do_periodo, 'WW') AS semana,
    SUM(
      numero_minimo_de_entregadores_regulares_na_escala *
      (EXTRACT(EPOCH FROM (duracao_do_periodo::interval)) / 3600.0)
    ) AS horas_a_entregar_segundos,
    COALESCE(
      SUM(EXTRACT(EPOCH FROM (tempo_disponivel_absoluto::interval))),
      0
    ) AS horas_entregues_segundos
  FROM dados_unicos du
  LEFT JOIN public.dados_corridas dc ON
    du.data_do_periodo = dc.data_do_periodo AND
    du.periodo = dc.periodo AND
    du.numero_minimo_de_entregadores_regulares_na_escala = dc.numero_minimo_de_entregadores_regulares_na_escala
  GROUP BY TO_CHAR(data_do_periodo, 'WW')
  ORDER BY semana DESC
)
SELECT
  semana,
  TO_CHAR(
    INTERVAL '1 second' * FLOOR(horas_a_entregar_segundos),
    'HH24:MI:SS'
  ) AS horas_a_entregar,
  TO_CHAR(
    INTERVAL '1 second' * FLOOR(horas_entregues_segundos),
    'HH24:MI:SS'
  ) AS horas_entregues,
  CASE
    WHEN horas_a_entregar_segundos > 0 THEN
      ROUND((horas_entregues_segundos / horas_a_entregar_segundos) * 100, 2)
    ELSE 0
  END AS aderencia_percentual
FROM horas_por_semana;
$$;

GRANT EXECUTE ON FUNCTION public.dashboard_totals() TO anon, authenticated, service_role;
GRANT EXECUTE ON FUNCTION public.calcular_aderencia_semanal() TO anon, authenticated, service_role;
```

### 5. Execute o projeto
```bash
npm run dev
```

Acesse http://localhost:3000

## ğŸ“‹ Como Usar

### Upload de Dados
1. VÃ¡ para a pÃ¡gina "Upload"
2. Selecione um arquivo Excel (.xlsx ou .xls)
3. Clique em "Enviar Dados"
4. Aguarde o processamento (pode levar alguns minutos para arquivos grandes)

### Dashboard
- **PÃ¡gina inicial**: Mostra totais de corridas e mÃ©tricas de aderÃªncia
- **Indicadores visuais**: GrÃ¡fico circular para percentual de aderÃªncia
- **HistÃ³rico**: Tabela com dados das Ãºltimas 10 semanas

## ğŸ”§ Estrutura do Projeto

```
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ page.tsx           # Dashboard principal
â”‚   â”‚   â”œâ”€â”€ upload/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx       # PÃ¡gina de upload
â”‚   â”‚   â””â”€â”€ layout.tsx         # Layout raiz
â”‚   â””â”€â”€ lib/
â”‚       â””â”€â”€ supabaseClient.ts  # Cliente Supabase
â”œâ”€â”€ dashboard_rpc.sql          # FunÃ§Ãµes SQL para o banco
â””â”€â”€ README.md
```

## ğŸ¯ CÃ¡lculo de AderÃªncia

O sistema replica exatamente o mÃ©todo usado no Excel:

1. **Remove duplicatas** baseado em data, perÃ­odo e escala mÃ­nima
2. **Calcula horas a entregar**: `escala_mÃ­nima Ã— duraÃ§Ã£o_perÃ­odo`
3. **Soma horas entregues**: `tempo_disponÃ­vel_absoluto` de todos os registros relacionados
4. **Calcula percentual**: `(horas_entregues / horas_a_entregar) Ã— 100`

### Exemplo prÃ¡tico:
- Semana 35: 14.893:54:00 (a entregar) vs 5.048:50:56 (entregues) = 33,9%

## ğŸš¨ Limites e ConsideraÃ§Ãµes

- **Supabase PostgREST**: Limitado a 1000 linhas por consulta
- **RPC Functions**: Usadas para aggregaÃ§Ãµes sem limite
- **Upload**: Processa arquivos grandes com batching (500 registros/lote)
- **Performance**: Otimizado para datasets de atÃ© 100k+ linhas

## ğŸ”’ SeguranÃ§a

- RLS habilitado na tabela
- PolÃ­ticas de leitura/escrita configuradas
- Dados sensÃ­veis protegidos via variÃ¡veis de ambiente

## ğŸ“ˆ PrÃ³ximas Funcionalidades

- Filtros por data/perÃ­odo/praÃ§a
- Export de relatÃ³rios
- GrÃ¡ficos avanÃ§ados
- NotificaÃ§Ãµes de upload
- Backup automÃ¡tico

---

Desenvolvido para anÃ¡lise de performance de entregadores com foco em mÃ©tricas de aderÃªncia operacional.
